<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡”ã®è§’åº¦ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼†ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ï¼ˆæ“ä½œãƒœã‚¿ãƒ³ä»˜ãï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
        #status {
            color: #555;
            margin-bottom: 20px;
            min-height: 20px;
        }
        .main-content {
            display: flex;
            gap: 20px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #output_canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        .controls, .data-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        button, label.button {
            flex: 1;
            padding: 12px 15px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #webcamButton { background-color: #1a73e8; }
        #webcamButton:hover:not(:disabled) { background-color: #155ab3; }
        label.button { background-color: #34a853; }
        label.button:hover { background-color: #2c8e45; }
        #downloadButton { background-color: #ff6f61; }
        #downloadButton:hover:not(:disabled) { background-color: #e65a50; }
        #playButton { background-color: #4285f4; }
        #playButton:hover:not(:disabled) { background-color: #357ae8; }
        #pauseButton { background-color: #fbbc05; }
        #pauseButton:hover:not(:disabled) { background-color: #f2a600; }
        #stopButton { background-color: #ea4335; }
        #stopButton:hover:not(:disabled) { background-color: #d93025; }

        input[type="file"] { display: none; }
        
        #angles-display {
            background-color: #e8f0fe;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #1a73e8;
        }
        .log-container {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #log-table {
            width: 100%;
            border-collapse: collapse;
        }
        #log-table th, #log-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #log-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>é¡”ã®è§’åº¦ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼†ãƒ‡ãƒ¼ã‚¿è¨˜éŒ² ğŸ§‘â€ğŸ’»</h1>
        <p id="status">AIãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>

        <div class="main-content">
            <div class="video-container">
                <video id="input_video" style="display: none;"></video>
                <canvas id="output_canvas"></canvas>
            </div>

            <div class="data-section">
                <div class="controls">
                    <h2>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h2>
                    <div class="button-group">
                        <button id="webcamButton">Webã‚«ãƒ¡ãƒ©</button>
                        <label for="videoFileInput" class="button">å‹•ç”»é¸æŠ</label>
                        <input type="file" id="videoFileInput" accept="video/*">
                    </div>
                    <div class="button-group">
                        <button id="playButton" disabled>â–¶ å†ç”Ÿ/å†é–‹</button>
                        <button id="pauseButton" disabled>âšâš ä¸€æ™‚åœæ­¢</button>
                        <button id="stopButton" disabled>â–  çµ‚äº†ï¼†ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <button id="downloadButton">ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
                
                <div>
                    <h2>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è§’åº¦ (åº¦)</h2>
                    <div id="angles-display">
                        Yaw (å·¦å³): 0.00 <br>
                        Pitch (ä¸Šä¸‹): 0.00 <br>
                        Roll (å‚¾ã): 0.00
                    </div>
                </div>

                <div>
                    <h2>è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿</h2>
                    <div class="log-container">
                        <table id="log-table">
                            <thead>
                                <tr>
                                    <th>æ™‚åˆ»</th>
                                    <th>Yaw</th>
                                    <th>Pitch</th>
                                    <th>Roll</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    // --- 1. åŸºæœ¬çš„ãªè¦ç´ ã®æº–å‚™ ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusText = document.getElementById('status');
    const webcamButton = document.getElementById('webcamButton');
    const videoFileInput = document.getElementById('videoFileInput');
    const downloadButton = document.getElementById('downloadButton');
    const anglesDisplay = document.getElementById('angles-display');
    const logTableBody = document.querySelector('#log-table tbody');
    // â˜…â˜…â˜… è¿½åŠ ã—ãŸãƒœã‚¿ãƒ³è¦ç´  â˜…â˜…â˜…
    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');
    const stopButton = document.getElementById('stopButton');

    let logData = [];
    let activeStream = false;

    // --- 2. é¡”ã®è§’åº¦ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—) ---
    function calculateFaceAngles(landmarks) {
        if (!landmarks || landmarks.length === 0) return null;
        const p1 = landmarks[1], p152 = landmarks[152], p33 = landmarks[33], p263 = landmarks[263];
        const roll = Math.atan2(p263.y - p33.y, p263.x - p33.x);
        const pitch = Math.atan2(p1.y - p152.y, Math.sqrt(Math.pow(p1.x - p152.x, 2) + Math.pow(p1.z - p152.z, 2)));
        const yaw = Math.atan2(p263.x - p33.x, p263.z - p33.z);
        return {
            yaw: yaw * (180 / Math.PI),
            pitch: pitch * (180 / Math.PI) * -1,
            roll: roll * (180 / Math.PI)
        };
    }

    // --- 3. MediaPipeã‹ã‚‰çµæœã‚’å—ã‘å–ã£ãŸã¨ãã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    function onResults(results) {
        statusText.textContent = 'é¡”ã‚’æ¤œå‡ºä¸­...';
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            for (const landmarks of results.multiFaceLandmarks) {
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, { color: '#C0C0C070', lineWidth: 1 });
            }
            const angles = calculateFaceAngles(results.multiFaceLandmarks[0]);
            if (angles) {
                anglesDisplay.innerHTML = `Yaw (å·¦å³): ${angles.yaw.toFixed(2)} <br>Pitch (ä¸Šä¸‹): ${angles.pitch.toFixed(2)} <br>Roll (å‚¾ã): ${angles.roll.toFixed(2)}`;
                const newRecord = { time: new Date().toLocaleTimeString(), yaw: angles.yaw.toFixed(2), pitch: angles.pitch.toFixed(2), roll: angles.roll.toFixed(2) };
                logData.push(newRecord);
                const newRow = logTableBody.insertRow(0);
                newRow.innerHTML = `<td>${newRecord.time}</td><td>${newRecord.yaw}</td><td>${newRecord.pitch}</td><td>${newRecord.roll}</td>`;
            }
        }
        canvasCtx.restore();
    }

    // --- 4. MediaPipe Face Mesh ã®åˆæœŸåŒ– (å¤‰æ›´ãªã—) ---
    const faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    faceMesh.onResults(onResults);

    // --- 5. ã‚«ãƒ¡ãƒ©ã‚„å‹•ç”»ã®åˆ¶å¾¡ (å¤‰æ›´ãƒ»è¿½åŠ ã‚ã‚Š) ---
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            if (activeStream) await faceMesh.send({ image: videoElement });
        },
        width: 640, height: 480
    });

    function startWebcam() {
        stopAllStreams();
        activeStream = true;
        statusText.textContent = 'Webã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
        setPlaybackButtonsState(false); // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        camera.start();
    }
    
    function startVideoFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        stopAllStreams();
        const url = URL.createObjectURL(file);
        videoElement.src = url;
        videoElement.onloadeddata = () => {
            statusText.textContent = 'å‹•ç”»ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚ã€Œå†ç”Ÿ/å†é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            setPlaybackButtonsState(true, false); // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        };
    }
    
    async function sendVideoFrame() {
        if (!activeStream || videoElement.paused || videoElement.ended) return;
        await faceMesh.send({ image: videoElement });
        requestAnimationFrame(sendVideoFrame); // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    }
    
    function stopAllStreams() {
        activeStream = false;
        videoElement.pause();
        if (videoElement.srcObject) {
            videoElement.srcObject.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        videoElement.removeAttribute('src');
        setPlaybackButtonsState(false); // å…¨ã¦ã®å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    }
    
    // â˜…â˜…â˜… è¿½åŠ : å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
    function setPlaybackButtonsState(canPlay, isPlaying = false) {
        playButton.disabled = !canPlay || isPlaying;
        pauseButton.disabled = !canPlay || !isPlaying;
        stopButton.disabled = !canPlay;
    }

    // â˜…â˜…â˜… è¿½åŠ : å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    function handlePlay() {
        activeStream = true;
        videoElement.play();
        sendVideoFrame();
        statusText.textContent = 'æ¸¬å®šä¸­...';
        setPlaybackButtonsState(true, true);
    }
    
    function handlePause() {
        activeStream = false;
        videoElement.pause();
        statusText.textContent = 'ä¸€æ™‚åœæ­¢ä¸­ã€‚ã€Œå†ç”Ÿ/å†é–‹ã€ã§æ¸¬å®šã‚’ç¶šè¡Œã§ãã¾ã™ã€‚';
        setPlaybackButtonsState(true, false);
    }
    
    function handleStop() {
        stopAllStreams();
        logData = [];
        logTableBody.innerHTML = '';
        anglesDisplay.innerHTML = 'Yaw (å·¦å³): 0.00 <br>Pitch (ä¸Šä¸‹): 0.00 <br>Roll (å‚¾ã): 0.00';
        statusText.textContent = 'æ¸¬å®šã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
    }

    // --- 6. CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (å¤‰æ›´ãªã—) ---
    function downloadCSV() {
        if (logData.length === 0) {
            alert('è¨˜éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8,Time,Yaw,Pitch,Roll\r\n";
        logData.forEach(row => { csvContent += `${row.time},${row.yaw},${row.pitch},${row.roll}\r\n`; });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "face_angle_log.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- 7. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
    webcamButton.addEventListener('click', startWebcam);
    videoFileInput.addEventListener('change', startVideoFile);
    downloadButton.addEventListener('click', downloadCSV);
    // â˜…â˜…â˜… è¿½åŠ ã—ãŸãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â˜…â˜…â˜…
    playButton.addEventListener('click', handlePlay);
    pauseButton.addEventListener('click', handlePause);
    stopButton.addEventListener('click', handleStop);

    (async () => {
        await faceMesh.initialize();
        statusText.textContent = 'æº–å‚™å®Œäº†ã€‚Webã‚«ãƒ¡ãƒ©ã¾ãŸã¯å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
    })();

</script>
</body>
</html>